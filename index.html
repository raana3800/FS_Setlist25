<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getDatabase, ref, set, remove, onValue } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";
    import Sortable from "https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js";

  const firebaseConfig = {
  apiKey: "AIzaSyBFsxxC_WXKz6EIFB9PltvxVqTDt4wLXSw",
  authDomain: "setlist2025v2.firebaseapp.com",
  databaseURL: "https://setlist2025v2-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "setlist2025v2",
  storageBucket: "setlist2025v2.appspot.com",
  messagingSenderId: "398787404979",
  appId: "1:398787404979:web:0b397889973390045c3cc6"
};


    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    async function initializeSongs() {
      const defaultSongs = [
        { title: "Don't Change", bpm: 164 },
        { title: "Ready to Start", bpm: 190 },
        { title: "Cities in Dust", bpm: 120 },
        { title: "Hungry Like the Wolf", bpm: 128 },
        { title: "The Safety Dance", bpm: 102 },
        { title: "Early Morning Wake Up Call", bpm: 166 },
        { title: "A Forest", bpm: 153 },
        { title: "I Ran (So Far Away)", bpm: 145.5 },
        { title: "Enola Gay", bpm: 143 },
        { title: "You Spin Me Round (Like a Record)", bpm: 128 },
        { title: "You Keep Me Hangin' On", bpm: 132 },
        { title: "Touch Me (I Want Your Body)", bpm: 121 }
      ];

      const songsRef = ref(db, 'songs');
      const orderRef = ref(db, 'order');
      const songEntries = {};
      const order = [];

      defaultSongs.forEach((song, index) => {
        const id = `s${index}`;
        songEntries[id] = song;
        order.push(id);
      });

      await set(songsRef, songEntries);
      await set(orderRef, order);
    }

    function renderSongs(songList) {
      const tableBody = document.getElementById('tableBody');
      tableBody.innerHTML = '';

      const clickSounds = [
        new Audio('https://cdn.pixabay.com/download/audio/2022/03/26/audio_593b28b1d7.mp3?filename=game-notification-132514.mp3'),
        new Audio('https://cdn.pixabay.com/download/audio/2021/09/01/audio_cdd7e7605e.mp3?filename=menu-click-110999.mp3'),
        new Audio('https://cdn.pixabay.com/download/audio/2022/03/15/audio_a7e5fc4f97.mp3?filename=quick-click-124763.mp3')
      ];

      const successSound = new Audio('https://cdn.pixabay.com/download/audio/2022/03/15/audio_6e1b9217e2.mp3?filename=success-1-6297.mp3');

      songList.forEach((song, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="drag-handle">≡</td>
          <td>${index + 1}</td>
          <td class="song-title">${song.title}</td>
          <td class="status red">✗</td>
          <td class="status red">✗</td>
          <td class="status red">✗</td>
          <td class="status red">✗</td>
          <td class="status red">✗</td>
          <td><input type="number" class="bpm-input" value="${song.bpm}" min="60" max="240"></td>
        `;
        tableBody.appendChild(row);
      });

      new Sortable(tableBody, { handle: '.drag-handle', animation: 150 });

      document.querySelectorAll('.bpm-input').forEach(input => {
        input.addEventListener('change', () => {
          input.classList.add('highlight');
          setTimeout(() => input.classList.remove('highlight'), 600);
        });
      });

      document.querySelectorAll('.status').forEach(status => {
        status.addEventListener('click', () => {
          const sound = clickSounds[Math.floor(Math.random() * clickSounds.length)];
          sound.currentTime = 0;
          sound.play();

          if (status.classList.contains('red')) {
            status.classList.remove('red');
            status.classList.add('green');
            status.innerText = '✓';
          } else {
            status.classList.remove('green');
            status.classList.add('red');
            status.innerText = '✗';
          }

          const row = status.closest('tr');
          const statuses = row.querySelectorAll('.status');
          const allGreen = Array.from(statuses).every(s => s.classList.contains('green'));
          if (allGreen) {
            successSound.currentTime = 0;
            successSound.play();
          }
        });
      });
    }

    function listenToDatabase() {
      const songsRef = ref(db, 'songs');
      const orderRef = ref(db, 'order');

      onValue(orderRef, orderSnap => {
        const order = orderSnap.val();
        if (!order) return;
        onValue(songsRef, songsSnap => {
          const songs = songsSnap.val();
          if (!songs) return;
          const songList = order.map(id => ({ id, title: songs[id].title, bpm: songs[id].bpm }));
          renderSongs(songList);
        });
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('resetButton').addEventListener('click', async () => {
        if (confirm('Willst du die Setlist wirklich komplett zurücksetzen?')) {
          await remove(ref(db, 'songs'));
          await remove(ref(db, 'order'));
          await initializeSongs();
          setTimeout(() => location.reload(), 1000);
        }
      });
      listenToDatabase();
    });
</script>
