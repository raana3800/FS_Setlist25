<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Band-Setlist ‚Äì Echtzeit mit Griff-Handle</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJ0oszgQj1sJFABt4R4OEos3629dmS5RU",
      authDomain: "fssetlist.firebaseapp.com",
      databaseURL: "https://fssetlist-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "fssetlist",
      storageBucket: "fssetlist.firebasestorage.app",
      messagingSenderId: "765650285468",
      appId: "1:765650285468:web:68d940c531ce1cbcd38e59"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.db = db;
    window.dbRef = ref;
    window.dbSet = set;
    window.dbOnValue = onValue;
  </script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap');
    body { background-color: #2e4d2c; font-family: 'Patrick Hand', cursive; color: #fff; padding: 10px 20px 20px 20px; margin: 0; text-align: center; }
    img.logo { max-width: 250px; margin-top: 5px; margin-bottom: 5px; }
    h1 { font-size: 2.5rem; margin-top: 5px; margin-bottom: 10px; color: #fdfdfd; text-shadow: 1px 1px 2px #000; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background-color: transparent; }
    th, td { border: 1px solid #ffffff88; padding: 10px; text-align: center; font-size: 1rem; }
    .status { cursor: pointer; font-size: 1.5em; }
    .green { color: #00ff00; }
    .red { color: #ff6666; }
    .song-title { font-weight: bold; font-size: 1.2rem; font-family: 'Patrick Hand', cursive; }
    .drag-handle { cursor: grab; font-size: 1.5rem; }
    input.bpm-input { width: 60px; padding: 5px; font-size: 1rem; text-align: center; }
    thead th { font-size: 1.3rem; background-color: #3a5f39; }
    tr.draggable { cursor: default; }
    @media (max-width: 768px) { th, td { font-size: 0.9rem; padding: 6px; } h1 { font-size: 2rem; } }
  </style>
</head>
<body>

  <img src="FS_Logo Kopie.png" alt="Ferkel Sharky Logo" class="logo">
  <h1>Setlist</h1>

  <table id="setlistTable">
    <thead>
      <tr>
        <th>‚â°</th>
        <th>#</th>
        <th>Songtitel</th>
        <th>ü•Å</th>
        <th>üéπ</th>
        <th>üé∏</th>
        <th>ùÑ¢</th>
        <th>üé§</th>
        <th>BPM</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <script type="module">
    const { db, dbRef, dbSet, dbOnValue } = window;

    const defaultSongs = [
      "Don't Change", "Ready to Start", "Cities in Dust", "Hungry Like the Wolf",
      "Safety Dance", "Early Morning Wake Up Call", "A Forest", "I Ran",
      "Enola Gay", "You Spin Me Round", "You Keep Me Hanging On", "Touch Me"
    ];
    const columns = ["Drums", "Keyboards", "Gitarre", "Bass", "Gesang"];

    const tableBody = document.getElementById('tableBody');

    function createRow(song, index) {
      const row = document.createElement('tr');
      row.classList.add('draggable');
      row.setAttribute('draggable', 'true');
      row.dataset.songId = song.id;
      let html = `<td class="drag-handle">‚â°</td><td class="song-number">${index + 1}</td><td class="song-title">${song.title}</td>`;
      columns.forEach(col => {
        const cellId = `${song.id}_${col.toLowerCase()}`;
        const statusClass = song.statuses && song.statuses[col.toLowerCase()] === 'green' ? 'green' : 'red';
        const statusSymbol = statusClass === 'green' ? '‚úì' : '‚úó';
        html += `<td id="${cellId}" class="status ${statusClass}">${statusSymbol}</td>`;
      });
      const bpmValue = song.bpm || 120;
      html += `<td><input type="number" min="60" max="240" value="${bpmValue}" class="bpm-input" id="${song.id}_bpm"></td>`;
      row.innerHTML = html;
      return row;
    }

    function updateSongNumbers() {
      document.querySelectorAll('#tableBody tr').forEach((tr, index) => {
        tr.querySelector('.song-number').textContent = index + 1;
      });
    }

    async function saveOrder() {
      const rows = Array.from(document.querySelectorAll('#tableBody tr'));
      const newOrder = rows.map(row => row.dataset.songId);
      await dbSet(dbRef(db, 'order/'), newOrder);
    }

    function attachListeners() {
      document.querySelectorAll('.status').forEach(cell => {
        cell.addEventListener('click', async () => {
          const isGreen = cell.classList.contains('green');
          const parts = cell.id.split('_');
          const songId = parts[0];
          const instrument = parts[1];
          await dbSet(dbRef(db, `songs/${songId}/statuses/${instrument}`), isGreen ? 'red' : 'green');
        });
      });

      document.querySelectorAll('.bpm-input').forEach(input => {
        input.addEventListener('change', async () => {
          let bpm = parseInt(input.value);
          if (bpm < 60) bpm = 60;
          if (bpm > 240) bpm = 240;
          input.value = bpm;
          const songId = input.id.split('_')[0];
          await dbSet(dbRef(db, `songs/${songId}/bpm`), bpm);
        });
      });
    }

    function renderSongs(songList) {
      tableBody.innerHTML = '';
      songList.forEach((song, index) => {
        tableBody.appendChild(createRow(song, index));
      });
      attachListeners();
      updateSongNumbers();
    }

    function listenToDatabase() {
      dbOnValue(dbRef(db, 'songs/'), snapshot => {
        const songsData = snapshot.val();
        dbOnValue(dbRef(db, 'order/'), orderSnapshot => {
          const order = orderSnapshot.val();
          if (songsData && order) {
            const songList = order.map(id => ({ id, title: songsData[id].title, statuses: songsData[id].statuses, bpm: songsData[id].bpm }));
            renderSongs(songList);
          }
        });
      });
    }

    async function initializeSongs() {
      const songEntries = {};
      defaultSongs.forEach((title, index) => {
        songEntries[`s${index}`] = { title, bpm: 120 };
      });
      await dbSet(dbRef(db, 'songs/'), songEntries);
      await dbSet(dbRef(db, 'order/'), Object.keys(songEntries));
    }

    dbOnValue(dbRef(db, 'songs/'), snapshot => {
      if (!snapshot.exists()) {
        initializeSongs();
      } else {
        listenToDatabase();
      }
    });

    new Sortable(tableBody, {
      animation: 150,
      handle: '.drag-handle',
      onEnd: () => {
        saveOrder();
        updateSongNumbers();
      }
    });

  </script>

</body>
</html>
